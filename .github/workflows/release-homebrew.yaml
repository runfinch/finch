# When a third-party action is added (i.e., `uses`), please also add it to `download-licenses` in Makefile.
# When the installers are ready in installer private bucket, run this workflow to test them.
# TODO: Add job of uploading installers to Github release when installer tests are stable.
# "release" runner tag is to make target hosts deterministic for easy clean up.
# TODO: Remove the "release" runner tag when installer tests are stable.
name: Release Homebrew
on:
  workflow_dispatch:
  push:

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

env:
  CASK: finch
  FORK_REPO: https://github.com/AnqiPang/homebrew-cask.git
  FORK_BRANCH: v0.3.0

jobs:
  # TODO: fix the arm64 test installer.
  # Currently the first time of calling any Finch command in arm64 hosts triggered by Github action will fail by
  # the error "Error: Process completed with exit code 137." So the arm64 job will fail.
  # We temporarily use follow-up manual steps to complete and clean up it.
  macos-arm64-test-installer:
    strategy:
      fail-fast: false
      matrix:
        os:
          [
            [self-hosted, macos, arm64, 11.7, release],
            [self-hosted, macos, arm64, 12.6, release],
            [self-hosted, macos, arm64, 13.0, release],
          ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    env:
      ACCESS_TOKEN: ${{ secrets.FINCH_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: "v0.3.0"
      - name: Clean up previous files
        run: |
          sudo rm -rf /opt/finch
          sudo rm -rf ~/.finch
          if pgrep '^qemu-system'; then
            sudo pkill '^qemu-system'
          fi
          if pgrep '^socket_vmnet'; then
            sudo pkill '^socket_vmnet'
          fi
          brew uninstall --cask finch || true
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Checkout the Fork Repo
        run: |
          brew update-reset 
          cd $(brew --repo homebrew/cask)
          git remote rm fork-repo || true
          git remote add fork-repo ${{ env.FORK_REPO }}
          git fetch fork-repo
          git checkout -B ${{ env.FORK_BRANCH }} fork-repo/${{ env.FORK_BRANCH }}
      - name: Cask Syntax
        run: |
          brew audit --cask --online ${{ env.CASK }}
          brew style --fix ${{ env.CASK }}
      - name: Silently install
        run: |
          brew install --cask finch
      - name: Run e2e tests
        run: INSTALLED=true make test-e2e
      - name: Silently uninstall
        run: brew uninstall --cask finch

  macos-amd64-test-installer:
    strategy:
      fail-fast: false
      matrix:
        os:
          [
            [self-hosted, macos, amd64, 10.15, release],
            [self-hosted, macos, amd64, 11.7, release],
            [self-hosted, macos, amd64, 12.6, release],
            [self-hosted, macos, amd64, 13.0, release],
          ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    env:
      ACCESS_TOKEN: ${{ secrets.FINCH_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: "v0.3.0"
      - name: Clean up previous files
        run: |
          sudo rm -rf /opt/finch
          sudo rm -rf ~/.finch
          if pgrep '^qemu-system'; then
            sudo pkill '^qemu-system'
          fi
          if pgrep '^socket_vmnet'; then
            sudo pkill '^socket_vmnet'
          fi 
          brew uninstall --cask finch || true
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Checkout the Fork Repo
        run: |
          brew update-reset 
          cd $(brew --repo homebrew/cask)
          git remote rm fork-repo || true
          git remote add fork-repo ${{ env.FORK_REPO }}
          git fetch fork-repo
          git checkout -B ${{ env.FORK_BRANCH }} fork-repo/${{ env.FORK_BRANCH }}
      - name: Cask Syntax
        run: |
          brew audit --cask --online ${{ env.CASK }}
          brew style --fix ${{ env.CASK }}
      - name: Silently install
        run: |
          brew install --cask finch
      - name: Run e2e tests
        run: INSTALLED=true make test-e2e
      - name: Silently uninstall
        run: brew uninstall --cask finch
